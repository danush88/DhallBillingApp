<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Page 4: View Bills by Month</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    input {
      padding: 8px;
      margin-bottom: 15px;
      width: 100%;
      max-width: 400px;
      font-size: 16px;
    }
    .bill-card {
      border: 1px solid #aaa;
      background-color: #fff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .month-header {
      background: #e8f4ff;
      padding: 10px;
      border-left: 4px solid #007bff;
      margin-top: 25px;
      font-weight: bold;
      font-size: 18px;
      border-radius: 5px;
    }
    .month-total {
      font-weight: bold;
      margin-top: 5px;
      color: #444;
    }
    .export-btn {
      margin-left: 10px;
      padding: 6px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .export-btn:hover {
      background: #0056b3;
    }
    @media print {
      nav, input, button {
        display: none;
      }
      .bill-card {
        border: none;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>

  <nav>
    <a href="page1_stock.html">Stock</a>
    <a href="page2_create_bill.html">Create Bill</a>
    <a href="page3_final_bill.html">Final Bill</a>
    <a href="page4_view_bills.html">View Bills</a>
  </nav>

  <h2>üìÖ View Bills by Month</h2>

  <label><strong>üîç Search by Shop Name:</strong></label><br>
  <input type="text" id="searchInput" placeholder="Enter shop name..." oninput="renderBills()">

  <div id="billList"></div>

  <script>
    const billList = document.getElementById("billList");
  
    function saveBillsToStorage(bills) {
      localStorage.setItem("bills", JSON.stringify(bills));
    }
  
    function getBills() {
      return JSON.parse(localStorage.getItem("bills")) || [];
    }
  
    function groupByMonth(billsArray) {
      const map = {};
      billsArray.forEach(bill => {
        const date = new Date(bill.date);
        const key = date.toLocaleString("default", { month: "long", year: "numeric" });
        if (!map[key]) map[key] = [];
        map[key].push(bill);
      });
  
      const sortedKeys = Object.keys(map).sort((a, b) => {
        const d1 = new Date("1 " + b);
        const d2 = new Date("1 " + a);
        return d1 - d2;
      });
  
      return { map, sortedKeys };
    }
  
    function exportMonthToExcel(monthKey, monthBills) {
      const data = [];
  
      monthBills.forEach((bill, i) => {
        bill.items.forEach(item => {
          data.push({
            "S.No": i + 1,
            "Shop Name": bill.shopName || "Unknown Shop",
            "Date": bill.date,
            "Item": item.name,
            "Qty": item.qty,
            "Rate": item.price,
            "Total": item.total.toFixed(2),
          });
        });
      });
  
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Bills");
      XLSX.writeFile(wb, `Dhall_Bills_${monthKey.replace(" ", "_")}.xlsx`);
    }
  
    function deleteItemFromBill(billIndex, itemIndex) {
      const bills = getBills();
      const bill = bills[billIndex];
  
      bill.items.splice(itemIndex, 1);
  
      // If no items left, delete whole bill
      if (bill.items.length === 0) {
        bills.splice(billIndex, 1);
      } else {
        bill.total = bill.items.reduce((sum, item) => sum + parseFloat(item.total), 0);
      }
  
      saveBillsToStorage(bills);
      renderBills();
    }
  
    function deleteBill(billIndex) {
      const bills = getBills();
      if (confirm("Are you sure you want to delete this entire bill?")) {
        bills.splice(billIndex, 1);
        saveBillsToStorage(bills);
        renderBills();
      }
    }
  
    function renderBills() {
      const bills = getBills();
      const search = document.getElementById("searchInput").value.toLowerCase();
      const filtered = bills.filter(bill =>
        (bill.shopName || "").toLowerCase().includes(search)
      );
  
      const { map, sortedKeys } = groupByMonth(filtered);
      billList.innerHTML = "";
  
      if (filtered.length === 0) {
        billList.innerHTML = "<p>No matching bills found.</p>";
        return;
      }
  
      let globalBillCounter = 0;
  
      sortedKeys.forEach(monthKey => {
        const monthBills = map[monthKey];
        let monthlyTotal = 0;
  
        const monthHeader = document.createElement("div");
        monthHeader.className = "month-header";
        monthHeader.innerHTML = `
          ${monthKey}
          <button class="export-btn" onclick='exportMonthToExcel("${monthKey}", ${JSON.stringify(monthBills).replace(/'/g, "\\'")})'>
            üì• Export Excel
          </button>
        `;
        billList.appendChild(monthHeader);
  
        monthBills.forEach((bill, billOffset) => {
          const billIndex = bills.findIndex(b => b.date === bill.date && b.shopName === bill.shopName && b.total === bill.total);
  
          let billTotal = 0;
          bill.items.forEach(item => {
            billTotal += parseFloat(item.total);
          });
          monthlyTotal += billTotal;
  
          const card = document.createElement("div");
          card.className = "bill-card";
          card.innerHTML = `
            <p><strong>üõçÔ∏è Shop:</strong> ${bill.shopName || "Unknown Shop"}</p>
            <p><strong>üìÖ Date:</strong> ${bill.date}</p>
            <p><strong>üßæ Bill Total:</strong> ‚Çπ${billTotal.toFixed(2)}</p>
            <button class="export-btn" onclick="deleteBill(${billIndex})">üóëÔ∏è Delete Bill</button>
            <table>
              <thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th><th>Action</th></tr></thead>
              <tbody>
                ${bill.items
                  .map(
                    (item, itemIndex) => `
                  <tr>
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>‚Çπ${item.price}</td>
                    <td>‚Çπ${item.total.toFixed(2)}</td>
                    <td><button onclick="deleteItemFromBill(${billIndex}, ${itemIndex})" style="color:red;">‚ùå</button></td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          `;
          billList.appendChild(card);
          globalBillCounter++;
        });
  
        const totalPara = document.createElement("p");
        totalPara.className = "month-total";
        totalPara.textContent = `üìä Monthly Total: ‚Çπ${monthlyTotal.toFixed(2)}`;
        billList.appendChild(totalPara);
      });
    }
  
    renderBills();
  </script>
  
</body>
</html>
